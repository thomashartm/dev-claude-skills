#!/usr/bin/env bash
#
# install-to-claude - Install/update Claude Code skills to ~/.claude/skills
#
# Usage:
#   install-to-claude                    Interactive mode
#   install-to-claude --all              Install all skills
#   install-to-claude <name>             Install specific skill
#   install-to-claude --uninstall <name> Uninstall specific skill
#   install-to-claude --cleanup          Remove backup directories
#   install-to-claude --list             List available skills
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CLAUDE_DIR="$HOME/.claude"
CLAUDE_SKILLS_DIR="$CLAUDE_DIR/skills"

# Options
DRY_RUN=false
FORCE=false
UNINSTALL=false

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Disable colors if not TTY
if [[ ! -t 1 ]]; then
    RED='' GREEN='' YELLOW='' CYAN='' BOLD='' DIM='' NC=''
fi

# ============================================================================
# Discovery Functions
# ============================================================================

get_skills() {
    local skills=()
    local skills_dir="$SCRIPT_DIR/skills"

    [[ ! -d "$skills_dir" ]] && echo "" && return

    for dir in "$skills_dir"/*/; do
        [[ ! -d "$dir" ]] && continue
        dir="${dir%/}"
        local name=$(basename "$dir")
        [[ "$name" == "TEMPLATE" ]] && continue
        [[ "$name" == ".git" ]] && continue
        [[ ! -f "$dir/SKILL.md" ]] && continue
        skills+=("$name")
    done
    echo "${skills[*]:-}"
}

is_skill() {
    local name="$1"
    [[ -f "$SCRIPT_DIR/skills/$name/SKILL.md" ]]
}

# ============================================================================
# Installation Functions
# ============================================================================

install_skill() {
    local skill_name="$1"
    local source_dir="$SCRIPT_DIR/skills/$skill_name"
    local target_dir="$CLAUDE_SKILLS_DIR/$skill_name"

    if [[ ! -d "$source_dir" ]]; then
        echo -e "  ${RED}ERROR: Skill '$skill_name' not found${NC}"
        return 1
    fi

    if [[ ! -f "$source_dir/SKILL.md" ]]; then
        echo -e "  ${RED}ERROR: '$skill_name' is not a valid skill (missing SKILL.md)${NC}"
        return 1
    fi

    if [[ "$DRY_RUN" == true ]]; then
        echo -e "  ${CYAN}[DRY RUN]${NC} Would install: $skill_name"
        return 0
    fi

    mkdir -p "$target_dir"
    rm -rf "${target_dir:?}"/*
    cp -R "$source_dir"/* "$target_dir/"

    # Make scripts executable
    find "$target_dir" -type f -name "*-tool" -exec chmod +x {} \;
    find "$target_dir" -type f -name "*.sh" -exec chmod +x {} \;

    echo -e "  ${GREEN}Installed:${NC} $skill_name"
}

uninstall_skill() {
    local skill_name="$1"
    local target_dir="$CLAUDE_SKILLS_DIR/$skill_name"

    if [[ ! -d "$target_dir" ]]; then
        echo -e "  ${YELLOW}Skill '$skill_name' not installed${NC}"
        return 0
    fi

    if [[ "$DRY_RUN" == true ]]; then
        echo -e "  ${CYAN}[DRY RUN]${NC} Would uninstall: $skill_name"
        return 0
    fi

    rm -rf "$target_dir"
    echo -e "  ${GREEN}Uninstalled:${NC} $skill_name"
}

# ============================================================================
# Cleanup Function
# ============================================================================

cleanup_backups() {
    echo ""
    echo -e "${BOLD}Cleaning up backup directories...${NC}"
    echo -e "${DIM}────────────────────────────────────────${NC}"

    local count=0

    # Clean skills backups
    if [[ -d "$CLAUDE_SKILLS_DIR" ]]; then
        while IFS= read -r -d '' backup; do
            if [[ "$DRY_RUN" == true ]]; then
                echo -e "  ${CYAN}[DRY RUN]${NC} Would remove: $(basename "$backup")"
            else
                rm -rf "$backup"
                echo -e "  ${GREEN}Removed:${NC} $(basename "$backup")"
            fi
            ((count++))
        done < <(find "$CLAUDE_SKILLS_DIR" -maxdepth 1 -type d -name "*.backup.*" -print0 2>/dev/null)
    fi

    # Clean commands backups (legacy)
    local commands_dir="$CLAUDE_DIR/commands"
    if [[ -d "$commands_dir" ]]; then
        while IFS= read -r -d '' backup; do
            if [[ "$DRY_RUN" == true ]]; then
                echo -e "  ${CYAN}[DRY RUN]${NC} Would remove: $(basename "$backup")"
            else
                rm -rf "$backup"
                echo -e "  ${GREEN}Removed:${NC} $(basename "$backup")"
            fi
            ((count++))
        done < <(find "$commands_dir" -maxdepth 1 -type d -name "*.backup.*" -print0 2>/dev/null)
    fi

    if [[ "$count" -eq 0 ]]; then
        echo -e "  ${DIM}No backup directories found${NC}"
    else
        echo ""
        if [[ "$DRY_RUN" == true ]]; then
            echo -e "  ${YELLOW}Would remove $count backup(s)${NC}"
        else
            echo -e "  ${GREEN}Removed $count backup(s)${NC}"
        fi
    fi
}

# ============================================================================
# Batch Operations
# ============================================================================

ensure_dir() {
    if [[ "$DRY_RUN" != true ]]; then
        mkdir -p "$CLAUDE_SKILLS_DIR"
    fi
}

install_all() {
    local skills
    read -ra skills <<< "$(get_skills)"

    if [[ ${#skills[@]} -eq 0 ]] || [[ -z "${skills[0]:-}" ]]; then
        echo -e "  ${DIM}No skills found${NC}"
        return 0
    fi

    for skill in "${skills[@]}"; do
        install_skill "$skill"
    done
}

# ============================================================================
# List & Interactive
# ============================================================================

list_skills() {
    local skills
    read -ra skills <<< "$(get_skills)"

    echo ""
    echo -e "${BOLD}Available Skills:${NC}"
    echo -e "${DIM}────────────────────────────────────────${NC}"

    if [[ ${#skills[@]} -eq 0 ]] || [[ -z "${skills[0]:-}" ]]; then
        echo -e "  ${DIM}(none)${NC}"
    else
        for skill in "${skills[@]}"; do
            local installed=""
            [[ -d "$CLAUDE_SKILLS_DIR/$skill" ]] && installed=" ${GREEN}(installed)${NC}"
            local desc=""
            if [[ -f "$SCRIPT_DIR/skills/$skill/SKILL.md" ]]; then
                desc=$(grep -m1 "^description:" "$SCRIPT_DIR/skills/$skill/SKILL.md" 2>/dev/null | sed 's/^description:[[:space:]]*//' | cut -c1-50 || echo "")
                [[ ${#desc} -eq 50 ]] && desc="${desc}..."
            fi
            echo -e "  ${CYAN}$skill${NC}$installed"
            [[ -n "$desc" ]] && echo -e "    ${DIM}$desc${NC}"
        done
    fi
    echo ""
}

interactive_menu() {
    local skills
    read -ra skills <<< "$(get_skills)"

    if [[ ${#skills[@]} -eq 0 ]] || [[ -z "${skills[0]:-}" ]]; then
        echo -e "${YELLOW}No skills found to install.${NC}"
        exit 0
    fi

    echo ""
    echo -e "${BOLD}Available Skills:${NC}"
    echo -e "${DIM}────────────────────────────────────────${NC}"

    local i=1
    for skill in "${skills[@]}"; do
        local installed=""
        [[ -d "$CLAUDE_SKILLS_DIR/$skill" ]] && installed=" ${GREEN}(installed)${NC}"
        echo -e "  ${CYAN}[$i]${NC} $skill$installed"
        ((i++))
    done

    echo ""
    echo -e "  ${CYAN}[a]${NC} Install ALL"
    echo -e "  ${CYAN}[c]${NC} Cleanup backups"
    echo -e "  ${CYAN}[q]${NC} Quit"
    echo ""

    read -rp "Select (number, 'a' for all, 'c' for cleanup, 'q' to quit): " choice

    case "$choice" in
        q|Q)
            echo "Cancelled."
            exit 0
            ;;
        a|A)
            ensure_dir
            echo ""
            echo -e "${BOLD}Installing Skills${NC}"
            echo -e "${DIM}────────────────────────────────────────${NC}"
            install_all
            ;;
        c|C)
            cleanup_backups
            ;;
        *)
            if [[ "$choice" =~ ^[0-9]+$ ]] && [[ "$choice" -ge 1 ]] && [[ "$choice" -le ${#skills[@]} ]]; then
                ensure_dir
                install_skill "${skills[$((choice-1))]}"
            else
                echo -e "${RED}Invalid selection${NC}"
                exit 1
            fi
            ;;
    esac
}

# ============================================================================
# Help
# ============================================================================

show_help() {
    cat << 'EOF'
install-to-claude - Install/update Claude Code skills

USAGE:
    install-to-claude                    Interactive mode
    install-to-claude --all              Install all skills
    install-to-claude <name>             Install specific skill
    install-to-claude --uninstall <name> Uninstall specific skill
    install-to-claude --cleanup          Remove .backup.* directories
    install-to-claude --list             List available skills
    install-to-claude --dry-run --all    Preview installation
    install-to-claude --help             Show this help

OPTIONS:
    -a, --all        Install all skills
    --cleanup        Remove backup directories from ~/.claude
    --dry-run        Show what would be done without doing it
    --force          Overwrite without creating backup
    --uninstall      Remove instead of install
    -l, --list       List available skills
    -h, --help       Show this help

EXAMPLES:
    ./install-to-claude                  # Interactive menu
    ./install-to-claude --all            # Install all skills
    ./install-to-claude list-plans       # Install specific skill
    ./install-to-claude --cleanup        # Remove old backups
    ./install-to-claude --uninstall gcp-cloudbuild

DESTINATION:
    Skills are installed to: ~/.claude/skills/

EOF
}

# ============================================================================
# Main
# ============================================================================

main() {
    local positional_args=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_help
                exit 0
                ;;
            -l|--list)
                list_skills
                exit 0
                ;;
            --cleanup)
                echo "=============================================="
                echo "  Claude Code Installer"
                echo "=============================================="
                cleanup_backups
                echo ""
                echo -e "${GREEN}Done!${NC}"
                exit 0
                ;;
            -a|--all)
                positional_args+=("--all")
                shift
                ;;
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            --force)
                FORCE=true
                shift
                ;;
            --uninstall)
                UNINSTALL=true
                shift
                ;;
            -*)
                echo -e "${RED}Unknown option: $1${NC}" >&2
                echo "Use --help for usage information" >&2
                exit 1
                ;;
            *)
                positional_args+=("$1")
                shift
                ;;
        esac
    done

    echo "=============================================="
    echo "  Claude Code Installer"
    echo "=============================================="

    if [[ "$DRY_RUN" == true ]]; then
        echo -e "${YELLOW}DRY RUN MODE - No changes will be made${NC}"
    fi

    if [[ " ${positional_args[*]:-} " =~ " --all " ]]; then
        ensure_dir
        if [[ "$UNINSTALL" == true ]]; then
            echo ""
            echo -e "${BOLD}Uninstalling all skills...${NC}"
            echo -e "${DIM}────────────────────────────────────────${NC}"
            local skills
            read -ra skills <<< "$(get_skills)"
            for skill in "${skills[@]}"; do
                [[ -n "$skill" ]] && uninstall_skill "$skill"
            done
        else
            echo ""
            echo -e "${BOLD}Installing Skills${NC}"
            echo -e "${DIM}────────────────────────────────────────${NC}"
            install_all
        fi
    elif [[ ${#positional_args[@]:-0} -gt 0 ]]; then
        ensure_dir
        local name="${positional_args[0]}"

        if [[ "$UNINSTALL" == true ]]; then
            if is_skill "$name" || [[ -d "$CLAUDE_SKILLS_DIR/$name" ]]; then
                uninstall_skill "$name"
            else
                echo -e "${RED}ERROR: '$name' not found${NC}"
                exit 1
            fi
        else
            if is_skill "$name"; then
                install_skill "$name"
            else
                echo -e "${RED}ERROR: Skill '$name' not found${NC}"
                echo "Use --list to see available skills"
                exit 1
            fi
        fi
    else
        interactive_menu
    fi

    echo ""
    if [[ "$DRY_RUN" == true ]]; then
        echo -e "${YELLOW}DRY RUN complete - no changes made${NC}"
    else
        echo -e "${GREEN}Done!${NC}"
    fi
    echo -e "Skills: $CLAUDE_SKILLS_DIR"
}

main "$@"
