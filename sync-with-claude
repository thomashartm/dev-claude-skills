#!/usr/bin/env bash
#
# sync-with-claude - Install/update Claude Code skills to ~/.claude/skills
#
# Usage:
#   sync-with-claude [skill-name]   Install specific skill
#   sync-with-claude --all          Install all skills
#   sync-with-claude                 Interactive mode - select skill(s)
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CLAUDE_SKILLS_DIR="$HOME/.claude/skills"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Get list of available skills (directories with SKILL.md)
get_skills() {
    local skills=()
    for dir in "$SCRIPT_DIR"/*/; do
        dir="${dir%/}"
        local name=$(basename "$dir")
        # Skip non-skill directories
        [[ "$name" == "TEMPLATE" ]] && continue
        [[ "$name" == ".git" ]] && continue
        [[ "$name" == ".claude" ]] && continue
        [[ ! -f "$dir/SKILL.md" ]] && continue
        skills+=("$name")
    done
    echo "${skills[@]}"
}

# Install a single skill
install_skill() {
    local skill_name="$1"
    local source_dir="$SCRIPT_DIR/$skill_name"
    local target_dir="$CLAUDE_SKILLS_DIR/$skill_name"

    if [[ ! -d "$source_dir" ]]; then
        echo -e "${RED}ERROR: Skill '$skill_name' not found${NC}"
        return 1
    fi

    if [[ ! -f "$source_dir/SKILL.md" ]]; then
        echo -e "${RED}ERROR: '$skill_name' is not a valid skill (missing SKILL.md)${NC}"
        return 1
    fi

    # Create target directory
    mkdir -p "$target_dir"

    # Copy all files from skill directory
    echo -e "  ${BLUE}Installing:${NC} $skill_name"

    # Remove existing files first for clean update
    rm -rf "${target_dir:?}"/*

    # Copy all files
    cp -R "$source_dir"/* "$target_dir/"

    # Make scripts executable
    find "$target_dir" -type f -name "*-tool" -exec chmod +x {} \;
    find "$target_dir" -type f -name "*.sh" -exec chmod +x {} \;

    echo -e "  ${GREEN}Installed:${NC} $skill_name -> $target_dir"
}

# Show interactive menu
interactive_menu() {
    local skills
    read -ra skills <<< "$(get_skills)"

    if [[ ${#skills[@]} -eq 0 ]]; then
        echo -e "${YELLOW}No skills found to install.${NC}"
        exit 0
    fi

    echo ""
    echo -e "${BOLD}Available Skills:${NC}"
    echo "----------------------------------------"

    local i=1
    for skill in "${skills[@]}"; do
        local desc=""
        if [[ -f "$SCRIPT_DIR/$skill/SKILL.md" ]]; then
            desc=$(grep -m1 "^description:" "$SCRIPT_DIR/$skill/SKILL.md" 2>/dev/null | sed 's/^description:[[:space:]]*//' | cut -c1-60 || echo "")
            [[ ${#desc} -eq 60 ]] && desc="${desc}..."
        fi
        echo -e "  ${CYAN}[$i]${NC} $skill"
        [[ -n "$desc" ]] && echo -e "      ${BLUE}$desc${NC}"
        ((i++))
    done

    echo ""
    echo -e "  ${CYAN}[a]${NC} Install ALL skills"
    echo -e "  ${CYAN}[q]${NC} Quit"
    echo ""

    read -rp "Select skill(s) to install (number, 'a' for all, or 'q' to quit): " choice

    case "$choice" in
        q|Q)
            echo "Cancelled."
            exit 0
            ;;
        a|A)
            install_all_skills
            ;;
        *)
            if [[ "$choice" =~ ^[0-9]+$ ]] && [[ "$choice" -ge 1 ]] && [[ "$choice" -le ${#skills[@]} ]]; then
                local selected_skill="${skills[$((choice-1))]}"
                ensure_skills_dir
                install_skill "$selected_skill"
            else
                echo -e "${RED}Invalid selection${NC}"
                exit 1
            fi
            ;;
    esac
}

# Install all skills
install_all_skills() {
    local skills
    read -ra skills <<< "$(get_skills)"

    if [[ ${#skills[@]} -eq 0 ]]; then
        echo -e "${YELLOW}No skills found to install.${NC}"
        exit 0
    fi

    ensure_skills_dir

    echo ""
    echo -e "${BOLD}Installing ${#skills[@]} skill(s)...${NC}"
    echo ""

    for skill in "${skills[@]}"; do
        install_skill "$skill"
    done

    echo ""
    echo -e "${GREEN}All skills installed successfully!${NC}"
}

# Ensure ~/.claude/skills directory exists
ensure_skills_dir() {
    if [[ ! -d "$CLAUDE_SKILLS_DIR" ]]; then
        echo -e "${YELLOW}Creating skills directory: $CLAUDE_SKILLS_DIR${NC}"
        mkdir -p "$CLAUDE_SKILLS_DIR"
    fi
}

# Show help
show_help() {
    cat << 'EOF'
sync-with-claude - Install/update Claude Code skills

USAGE:
    sync-with-claude                    Interactive mode - select skill(s)
    sync-with-claude <skill-name>       Install specific skill
    sync-with-claude --all              Install all skills
    sync-with-claude --list             List available skills
    sync-with-claude --help             Show this help

EXAMPLES:
    # Interactive selection
    sync-with-claude

    # Install specific skill
    sync-with-claude github-actions

    # Install all skills
    sync-with-claude --all

DESTINATION:
    Skills are installed to: ~/.claude/skills/

EOF
}

# List available skills
list_skills() {
    local skills
    read -ra skills <<< "$(get_skills)"

    if [[ ${#skills[@]} -eq 0 ]]; then
        echo "No skills found."
        exit 0
    fi

    echo "Available skills:"
    for skill in "${skills[@]}"; do
        local installed=""
        [[ -d "$CLAUDE_SKILLS_DIR/$skill" ]] && installed=" ${GREEN}(installed)${NC}"
        echo -e "  - $skill$installed"
    done
}

# Main
main() {
    echo "=============================================="
    echo "  Claude Code Skills Installer"
    echo "=============================================="

    case "${1:-}" in
        --help|-h)
            show_help
            ;;
        --list|-l)
            list_skills
            ;;
        --all|-a)
            install_all_skills
            ;;
        "")
            interactive_menu
            ;;
        *)
            # Specific skill name provided
            ensure_skills_dir
            install_skill "$1"
            ;;
    esac

    echo ""
    echo -e "${GREEN}Done!${NC} Skills are available at: $CLAUDE_SKILLS_DIR"
}

main "$@"
